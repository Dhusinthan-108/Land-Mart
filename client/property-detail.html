<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Property Detail - Land Mart</title>
    <link rel="stylesheet" href="styles/main.css">
</head>
<body>
    <header>
        <nav>
            <div class="logo">Land Mart</div>
            <ul>
                <li><a href="index.html">Home</a></li>
                <li><a href="properties.html">Properties</a></li>
                <li><a href="add-property.html">Sell Property</a></li>
                <li><a href="unified-dashboard.html">Dashboard</a></li>
                <li><a href="login.html">Login</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <section class="property-detail">
            <div class="property-images">
                <img id="property-image" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAwIiBoZWlnaHQ9IjQwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIyNCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPlByb3BlcnR5IEltYWdlPC90ZXh0Pjwvc3ZnPg==" alt="Property Image">
            </div>
            
            <div class="property-info">
                <h1 id="property-title">Loading property details...</h1>
                <p class="property-location" id="property-location"></p>
                
                <div class="property-price" id="property-price"></div>
                
                <div class="property-specs">
                    <div class="spec">
                        <strong>Size:</strong> <span id="property-size"></span>
                    </div>
                    <div class="spec">
                        <strong>Terrain:</strong> <span id="property-terrain"></span>
                    </div>
                    <div class="spec">
                        <strong>Status:</strong> <span id="property-status"></span>
                    </div>
                    <div class="spec">
                        <strong>Owner:</strong> <span id="property-owner"></span>
                    </div>
                </div>
                
                <div class="property-description">
                    <h2>Description</h2>
                    <p id="property-description"></p>
                </div>
                
                <!-- Edit form (hidden by default) -->
                <div id="edit-form" style="display: none;">
                    <h2>Edit Property</h2>
                    <form id="property-edit-form">
                        <div class="form-group">
                            <label for="edit-title">Title *</label>
                            <input type="text" id="edit-title" name="title" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="edit-description">Description *</label>
                            <textarea id="edit-description" name="description" rows="4" required></textarea>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="edit-price">Price (₹) *</label>
                                <input type="number" id="edit-price" name="price" min="0" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="edit-size">Size (sq.ft) *</label>
                                <input type="number" id="edit-size" name="size" min="0" required>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="edit-location">Location *</label>
                            <input type="text" id="edit-location" name="location" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="edit-terrain">Terrain</label>
                            <select id="edit-terrain" name="terrain">
                                <option value="flat">Flat</option>
                                <option value="hilly">Hilly</option>
                                <option value="marshy">Marshy</option>
                                <option value="rocky">Rocky</option>
                                <option value="forest">Forest</option>
                            </select>
                        </div>
                        
                        <div class="form-actions">
                            <button type="submit" class="btn-primary">Save Changes</button>
                            <button type="button" class="btn-secondary" onclick="cancelEdit()">Cancel</button>
                        </div>
                    </form>
                </div>
                
                <!-- Message form (hidden by default) -->
                <div id="message-form" style="display: none;">
                    <h2>Contact Seller</h2>
                    <form id="property-message-form">
                        <div class="form-group">
                            <label for="message-content">Your Message *</label>
                            <textarea id="message-content" name="content" rows="4" placeholder="Enter your inquiry about this property..." required></textarea>
                        </div>
                        
                        <div class="form-actions">
                            <button type="submit" class="btn-primary">Send Message</button>
                            <button type="button" class="btn-secondary" onclick="cancelMessage()">Cancel</button>
                        </div>
                    </form>
                </div>
                
                <div class="property-actions">
                    <button class="btn-primary" id="buy-now-btn" style="display: none;">Buy Now</button>
                    <button class="btn-secondary" id="contact-seller-btn" style="display: none;" onclick="startMessage()">Contact Seller</button>
                    <button class="btn-secondary" id="edit-property-btn" style="display: none;" onclick="startEdit()">Edit Property</button>
                    <button class="btn-secondary" onclick="window.history.back()">Back to Properties</button>
                </div>
            </div>
        </section>
    </main>

    <footer>
        <p>&copy; 2025 Land Mart. All rights reserved.</p>
    </footer>

    <script src="js/main.js"></script>
    <script>
        // Store property data globally
        let currentProperty = null;
        let currentUser = null;
        
        // Get property ID from URL parameter
        document.addEventListener('DOMContentLoaded', function() {
            // Get current user from localStorage
            currentUser = JSON.parse(localStorage.getItem('currentUser'));
            
            const urlParams = new URLSearchParams(window.location.search);
            const propertyId = urlParams.get('id');
            
            if (propertyId) {
                loadPropertyDetails(propertyId);
            } else {
                document.getElementById('property-title').textContent = 'Property not found';
                document.getElementById('property-image').src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAwIiBoZWlnaHQ9IjQwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIyNCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPlByb3BlcnR5IE5vdCBGb3VuZDwvdGV4dD48L3N2Zz4=';
            }
            
            // Add event listener for edit form
            const editForm = document.getElementById('property-edit-form');
            if (editForm) {
                editForm.addEventListener('submit', handlePropertyUpdate);
            }
            
            // Add event listener for message form
            const messageForm = document.getElementById('property-message-form');
            if (messageForm) {
                messageForm.addEventListener('submit', handleMessageSend);
            }
        });
        
        // Function to start messaging
        function startMessage() {
            if (!currentProperty || !currentUser) {
                alert('You must be logged in to contact the seller.');
                window.location.href = 'login.html';
                return;
            }
            
            // Hide property info and show message form
            document.querySelector('.property-info > h1').style.display = 'none';
            document.querySelector('.property-location').style.display = 'none';
            document.querySelector('.property-price').style.display = 'none';
            document.querySelector('.property-specs').style.display = 'none';
            document.querySelector('.property-description').style.display = 'none';
            document.getElementById('message-form').style.display = 'block';
            
            // Hide action buttons except back button
            document.getElementById('buy-now-btn').style.display = 'none';
            document.getElementById('contact-seller-btn').style.display = 'none';
            document.getElementById('edit-property-btn').style.display = 'none';
        }
        
        // Function to cancel messaging
        function cancelMessage() {
            // Show property info and hide message form
            document.querySelector('.property-info > h1').style.display = 'block';
            document.querySelector('.property-location').style.display = 'block';
            document.querySelector('.property-price').style.display = 'block';
            document.querySelector('.property-specs').style.display = 'block';
            document.querySelector('.property-description').style.display = 'block';
            document.getElementById('message-form').style.display = 'none';
            
            // Show appropriate action buttons
            if (currentUser && currentProperty && currentProperty.ownerId._id === currentUser.id) {
                document.getElementById('edit-property-btn').style.display = 'inline-block';
            } else {
                document.getElementById('buy-now-btn').style.display = 'inline-block';
                document.getElementById('contact-seller-btn').style.display = 'inline-block';
            }
        }
        
        // Function to handle message sending
        async function handleMessageSend(event) {
            event.preventDefault();
            
            if (!currentProperty || !currentUser) {
                alert('You must be logged in to send a message.');
                window.location.href = 'login.html';
                return;
            }
            
            // Get message content
            const content = document.getElementById('message-content').value.trim();
            if (!content) {
                alert('Please enter a message.');
                return;
            }
            
            try {
                // Prepare message data
                const messageData = {
                    senderId: currentUser.id,
                    receiverId: currentProperty.ownerId._id,
                    propertyId: currentProperty._id,
                    content: content
                };
                
                // Determine the correct API base URL
                const apiBaseUrl = 'http://localhost:5500';
                const apiUrl = `${apiBaseUrl}/api/messages`;
                
                // Send message to backend
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(messageData)
                });
                
                if (response.ok) {
                    const message = await response.json();
                    alert('Message sent successfully to the seller!');
                    
                    // Clear message form and hide it
                    document.getElementById('message-content').value = '';
                    cancelMessage();
                } else {
                    const errorData = await response.json();
                    alert('Error sending message: ' + errorData.message);
                }
            } catch (error) {
                console.error('Error sending message:', error);
                alert('An error occurred while sending the message. Please try again.');
            }
        }
        
        // Function to start editing
        function startEdit() {
            if (!currentProperty || !currentUser) return;
            
            // Hide property info and show edit form
            document.querySelector('.property-info > h1').style.display = 'none';
            document.querySelector('.property-location').style.display = 'none';
            document.querySelector('.property-price').style.display = 'none';
            document.querySelector('.property-specs').style.display = 'none';
            document.querySelector('.property-description').style.display = 'none';
            document.getElementById('edit-form').style.display = 'block';
            
            // Hide action buttons except back button
            document.getElementById('buy-now-btn').style.display = 'none';
            document.getElementById('contact-seller-btn').style.display = 'none';
            document.getElementById('edit-property-btn').style.display = 'none';
            
            // Populate form with current property data
            document.getElementById('edit-title').value = currentProperty.title;
            document.getElementById('edit-description').value = currentProperty.description;
            document.getElementById('edit-price').value = currentProperty.price;
            document.getElementById('edit-size').value = currentProperty.size;
            document.getElementById('edit-location').value = currentProperty.location;
            document.getElementById('edit-terrain').value = currentProperty.terrain;
        }
        
        // Function to cancel editing
        function cancelEdit() {
            // Show property info and hide edit form
            document.querySelector('.property-info > h1').style.display = 'block';
            document.querySelector('.property-location').style.display = 'block';
            document.querySelector('.property-price').style.display = 'block';
            document.querySelector('.property-specs').style.display = 'block';
            document.querySelector('.property-description').style.display = 'block';
            document.getElementById('edit-form').style.display = 'none';
            
            // Show appropriate action buttons
            if (currentUser && currentProperty && currentProperty.ownerId._id === currentUser.id) {
                document.getElementById('edit-property-btn').style.display = 'inline-block';
            } else {
                document.getElementById('buy-now-btn').style.display = 'inline-block';
                document.getElementById('contact-seller-btn').style.display = 'inline-block';
            }
        }
        
        // Function to handle property update
        async function handlePropertyUpdate(event) {
            event.preventDefault();
            
            if (!currentProperty || !currentUser) return;
            
            // Get form values
            const formData = {
                title: document.getElementById('edit-title').value,
                description: document.getElementById('edit-description').value,
                price: parseFloat(document.getElementById('edit-price').value),
                size: parseFloat(document.getElementById('edit-size').value),
                location: document.getElementById('edit-location').value,
                terrain: document.getElementById('edit-terrain').value,
                ownerId: currentUser.id
            };
            
            try {
                // Determine the correct API base URL
                const apiBaseUrl = 'http://localhost:5500';
                const apiUrl = `${apiBaseUrl}/api/properties/${currentProperty._id}`;
                
                // Send update request to backend
                const response = await fetch(apiUrl, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    const updatedProperty = await response.json();
                    alert('Property updated successfully!');
                    
                    // Update current property data
                    currentProperty = updatedProperty;
                    
                    // Update displayed property details
                    document.getElementById('property-title').textContent = updatedProperty.title;
                    document.getElementById('property-location').textContent = updatedProperty.location;
                    document.getElementById('property-price').textContent = `₹${updatedProperty.price.toLocaleString()}`;
                    document.getElementById('property-size').textContent = `${updatedProperty.size} sq.ft`;
                    document.getElementById('property-terrain').textContent = updatedProperty.terrain.replace('_', ' ');
                    document.getElementById('property-status').textContent = updatedProperty.status.replace('_', ' ');
                    document.getElementById('property-owner').textContent = updatedProperty.ownerId.name;
                    document.getElementById('property-description').textContent = updatedProperty.description;
                    
                    // Cancel edit mode
                    cancelEdit();
                } else {
                    const errorData = await response.json();
                    alert('Error updating property: ' + errorData.message);
                }
            } catch (error) {
                console.error('Error updating property:', error);
                alert('An error occurred while updating the property. Please try again.');
            }
        }
        
        // Modified loadPropertyDetails function to store property data and show edit button for owners
        async function loadPropertyDetails(propertyId) {
            try {
                // Determine the correct API base URL
                const apiBaseUrl = 'http://localhost:5500';
                
                // Fetch property details
                const response = await fetch(`${apiBaseUrl}/api/properties/${propertyId}`);
                
                if (!response.ok) {
                    throw new Error('Property not found');
                }
                
                const property = await response.json();
                currentProperty = property; // Store property data globally
                
                // Update page with property details
                document.getElementById('property-title').textContent = property.title;
                document.getElementById('property-location').textContent = property.location;
                document.getElementById('property-price').textContent = `₹${property.price.toLocaleString()}`;
                document.getElementById('property-size').textContent = `${property.size} sq.ft`;
                document.getElementById('property-terrain').textContent = property.terrain.replace('_', ' ');
                document.getElementById('property-status').textContent = property.status.replace('_', ' ');
                document.getElementById('property-owner').textContent = property.ownerId.name;
                document.getElementById('property-description').textContent = property.description;
                
                // Show action buttons based on user ownership
                if (currentUser && property.ownerId._id === currentUser.id) {
                    // Current user is the owner, show edit button
                    document.getElementById('edit-property-btn').style.display = 'inline-block';
                } else {
                    // Current user is not the owner, show buy/contact buttons
                    document.getElementById('buy-now-btn').style.display = 'inline-block';
                    document.getElementById('contact-seller-btn').style.display = 'inline-block';
                }
                
                console.log(`Loaded property details for: ${property.title}`);
            } catch (error) {
                console.error('Error loading property details:', error);
                document.getElementById('property-title').textContent = 'Property not found';
                document.getElementById('property-image').src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAwIiBoZWlnaHQ9IjQwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIyNCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPlByb3BlcnR5IE5vdCBGb3VuZDwvdGV4dD48L3N2Zz4=';
            }
        }
    </script>
</body>
</html>